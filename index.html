<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Controle de Estoque GOINFRA</title>
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.4/css/all.css" />
    <style>
        body {
            padding-top: 100px;
            background-color: #306aa4;
        }

        .fixed-header {
            position: fixed;
            top: 0;
            width: 100%;
            background: white;
            z-index: 1000;
            border-bottom: 1px solid #ccc;
            padding: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .card-user {
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 10px;
            margin-bottom: 15px;
            background: white;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }

        .btn-remove-software {
            color: red;
            cursor: pointer;
            font-size: 1.2em;
        }

        .estoque-toggle {
            cursor: pointer;
        }

        .icon-disponivel {
            color: green;
        }

        .icon-indisponivel {
            color: gray;
        }

        .usuarios-scroll {
            max-height: 500px;
            overflow-y: auto;
            padding-right: 10px;
        }

        .dispositivo-header {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            padding: 10px;
            background: #fff;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            border: 1px solid #dee2e6;
        }

        .dispositivo-item {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            background: #f8f9fa;
            border-radius: 6px;
            margin: 5px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            min-width: 180px;
        }

        .dispositivo-info {
            display: flex;
            flex-direction: column;
            margin-left: 8px;
        }

        .dispositivo-tipo {
            font-weight: bold;
            font-size: 14px;
            margin-bottom: 2px;
        }

        .dispositivo-totais {
            display: flex;
            align-items: center;
            font-size: 13px;
        }

        .disponivel {
            color: #28a745;
            font-weight: bold;
        }

        .indisponivel {
            color: #dc3545;
            font-weight: bold;
        }

        .total {
            color: #6c757d;
            font-weight: bold;
        }

        .separador {
            margin: 0 4px;
            color: #adb5bd;
        }

        .nav-tabs {
            margin-bottom: 20px;
            background: #fff;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .container {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }
        
        .software-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .software-info {
            flex-grow: 1;
        }
        
        .software-acoes {
            min-width: 100px;
            text-align: right;
        }
        
        .login-container {
            max-width: 400px;
            margin: 100px auto;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .user-info {
            position: fixed;
            top: 10px;
            right: 10px;
            background: white;
            padding: 5px 10px;
            border-radius: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            z-index: 1001;
        }
        
        .modelo-card {
            border-left: 4px solid #306aa4;
        }
        
        .patrimonio-list {
            max-height: 200px;
            overflow-y: auto;
        }
        
        .patrimonio-item {
            padding: 5px 10px;
            border-bottom: 1px solid #eee;
        }
    </style>
</head>

<body>
    <div id="app">
        <!-- Tela de Login -->
        <div v-if="!usuarioLogado" class="login-container">
            <h3 class="text-center mb-4">Acesso Administrativo</h3>
            <div class="form-group">
                <label>Usuário</label>
                <input type="text" class="form-control" v-model="login.usuario" placeholder="Digite seu usuário">
            </div>
            <div class="form-group">
                <label>Senha</label>
                <input type="password" class="form-control" v-model="login.senha" placeholder="Digite sua senha" @keyup.enter="fazerLogin">
            </div>
            <button class="btn btn-primary btn-block" @click="fazerLogin">Entrar</button>
            
            <div v-if="mensagemErro" class="alert alert-danger mt-3">
                {{ mensagemErro }}
            </div>
            
            <div class="mt-3 text-center">
                <p><small>Para acessar como visitante, clique <a href="#" @click.prevent="entrarComoVisitante">aqui</a></small></p>
            </div>
        </div>

        <!-- Sistema Principal -->
        <div v-if="usuarioLogado">
            <div class="user-info">
                <span v-if="isAdmin">Administrador</span>
                <span v-else>Visitante</span>
                <button class="btn btn-sm btn-link" @click="sair">Sair</button>
            </div>
            
            <div class="fixed-header">
                <h5>STCP ENGENHARIA</h5>
                <h3>CONTROLE DE ESTOQUE GOINFRA</h3>
            </div>

            <div class="container">
                <div class="dispositivo-header">
                    <!-- Dispositivos -->
                    <div v-for="(item, i) in totaisDispositivos" :key="'d'+i" class="dispositivo-item">
                        <i :class="[item.icone, 'mr-2']"></i>
                        <div class="dispositivo-info">
                            <span class="dispositivo-tipo">{{ item.tipo }}</span>
                            <div class="dispositivo-totais">
                                <span class="disponivel">{{ item.disponiveis }}D</span>
                                <span class="separador">/</span>
                                <span class="indisponivel">{{ item.indisponiveis }}I</span>
                                <span class="separador">|</span>
                                <span class="total">{{ item.total }}T</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Softwares -->
                    <div class="dispositivo-item">
                        <i class="fas fa-copyright mr-2"></i>
                        <div class="dispositivo-info">
                            <span class="dispositivo-tipo">Softwares</span>
                            <div class="dispositivo-totais">
                                <span class="disponivel">{{ totalSoftwaresDisponiveis }}D</span>
                                <span class="separador">/</span>
                                <span class="indisponivel">{{ totalSoftwaresIndisponiveis }}I</span>
                                <span class="separador">|</span>
                                <span class="total">{{ softwares.length }}T</span>
                            </div>
                        </div>
                    </div>
                </div>

                <ul class="nav nav-tabs mb-4">
                    <li class="nav-item"><a class="nav-link" :class="{active: abaAtiva==='atribuicao'}" href="#"
                            @click.prevent="abaAtiva='atribuicao'">Atribuição</a></li>
                    <li class="nav-item"><a class="nav-link" :class="{active: abaAtiva==='estoque'}" href="#"
                            @click.prevent="abaAtiva='estoque'">Estoque</a></li>
                    <li class="nav-item"><a class="nav-link" :class="{active: abaAtiva==='usuarios'}" href="#"
                            @click.prevent="abaAtiva='usuarios'">Usuários</a></li>
                    <li class="nav-item"><a class="nav-link" :class="{active: abaAtiva==='softwares'}" href="#"
                            @click.prevent="abaAtiva='softwares'">Softwares</a></li>
                    <li class="nav-item"><a class="nav-link" :class="{active: abaAtiva==='relatorio'}" href="#"
                            @click.prevent="abaAtiva='relatorio'">Relatório</a></li>
                </ul>

                <!-- Relatório -->
                <div v-if="abaAtiva==='relatorio'" class="card mb-4">
                    <h5>Relatório Mensal</h5>
                    <div class="form-inline">
                        <select v-model="mesRelatorio" class="form-control mr-2">
                            <option v-for="m in 12" :value="m">{{m}}</option>
                        </select>
                        <input type="number" v-model="anoRelatorio" class="form-control mr-2" placeholder="Ano" />
                        <button class="btn btn-primary" @click="gerarRelatorio()">Baixar CSV</button>
                    </div>
                </div>

                <!-- Atribuição (SEM CPF) -->
                <div v-if="abaAtiva==='atribuicao'">
                    <h4>Atribuir Equipamentos</h4>
                    <form @submit.prevent="atribuirEquipamentos">
                        <div class="form-row">
                            <div class="form-group col-md-4">
                                <input type="text" class="form-control" v-model="novoUsuario" placeholder="Nome" required />
                            </div>
                            <div class="form-group col-md-4">
                                <input type="email" class="form-control" v-model="novoEmail" placeholder="Email" />
                            </div>
                            <div class="form-group col-md-4">
                                <input type="text" class="form-control" v-model="novaLocalizacao" placeholder="Localização" />
                            </div>
                        </div>
                        <h5>Equipamentos Disponíveis</h5>
                        <div v-for="tipo in tiposEquipamentos" :key="tipo" class="mb-3">
                            <div class="estoque-toggle font-weight-bold mb-2" @click="toggleEstoque(tipo)">
                                <i :class="[iconeTipo(tipo),'mr-2']"></i> {{tipo}} - Disponíveis: {{contarDisponiveis(tipo)}} <i
                                    class="fas fa-chevron-down"></i>
                            </div>
                            <div v-if="estoqueVisivel[tipo]">
                                <div class="form-check" v-for="equip in equipamentosDisponiveis.filter(e=>e.tipo===tipo)"
                                    :key="equip.patrimonio">
                                    <input class="form-check-input" type="checkbox" :value="equip.patrimonio"
                                        v-model="equipamentosSelecionados" />
                                    <label class="form-check-label">
                                        <i :class="[iconeTipo(equip.tipo),'mr-2','icon-disponivel']"></i>{{equip.tipo}} –
                                        {{equip.modelo}} ({{equip.patrimonio}})
                                    </label>
                                </div>
                            </div>
                        </div>
                        <h5 class="mt-4">Softwares</h5>
                        <div v-for="(soft,i) in softwaresSelecionados" :key="i" class="form-row mb-2 align-items-center">
                            <div class="col-md-4">
                                <select class="form-control" v-model="soft.nome" @change="selecionarSoftware(i)">
                                    <option disabled value="">Selecione o software</option>
                                    <option v-for="sw in softwaresDisponiveis" :value="sw.nome" :disabled="sw.situacao === 'Indisponível'">
                                        {{sw.nome}} ({{sw.situacao}})
                                    </option>
                                    <option>Outro</option>
                                </select>
                            </div>
                            <div class="col-md-7"><input type="text" class="form-control" v-model="soft.chave"
                                    placeholder="Chave de acesso" /></div>
                            <div class="col-md-1"><span class="btn-remove-software" @click="removerSoftware(i)"><i
                                        class="fas fa-minus-circle"></i></span></div>
                        </div>
                        <button class="btn btn-secondary btn-sm mb-3"
                            @click.prevent="softwaresSelecionados.push({nome:'',chave:''})">Adicionar Software</button>
                        <button class="btn btn-primary mt-2" type="submit">Salvar Atribuição</button>
                    </form>
                </div>

                <!-- Estoque -->
                <div v-if="abaAtiva==='estoque'">
                    <h4>Estoque</h4>
                    
                    <!-- Cadastro de Modelos -->
                    <div v-if="isAdmin" class="card mb-4 modelo-card">
                        <div class="card-header bg-light">
                            <h5>Cadastrar Novo Modelo</h5>
                        </div>
                        <div class="card-body">
                            <form @submit.prevent="adicionarModelo" class="row g-3">
                                <div class="col-md-4">
                                    <label>Tipo</label>
                                    <select class="form-control" v-model="novoModelo.tipo" required>
                                        <option disabled value="">Selecione</option>
                                        <option>Monitor</option>
                                        <option>Notebook</option>
                                        <option>Tablet</option>
                                        <option>Desktop</option>
                                        <option value="outro">Outro</option>
                                    </select>
                                    <input v-if="novoModelo.tipo === 'outro'" class="form-control mt-2" 
                                           v-model="novoModelo.novoTipo" placeholder="Especificar tipo" required />
                                </div>
                                <div class="col-md-5">
                                    <label>Modelo</label>
                                    <input class="form-control" v-model="novoModelo.modelo" 
                                           placeholder="Ex: Dell Optiplex 7080" required />
                                </div>
                                <div class="col-md-3 d-flex align-items-end">
                                    <button type="submit" class="btn btn-primary w-100">
                                        <i class="fas fa-save"></i> Salvar Modelo
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Adição de Patrimônios -->
                    <div v-if="isAdmin && modelosCadastrados.length > 0" class="card mb-4">
                        <div class="card-header bg-light">
                            <h5>Adicionar Patrimônios</h5>
                        </div>
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label>Selecione o Modelo</label>
                                    <select class="form-control" v-model="modeloSelecionado" required>
                                        <option disabled value="">Selecione um modelo</option>
                                        <option v-for="(modelo, index) in modelosCadastrados" :value="index">
                                            {{ modelo.tipo }} - {{ modelo.modelo }}
                                        </option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-8">
                                    <label>Patrimônios (um por linha)</label>
                                    <textarea class="form-control" v-model="patrimoniosParaAdicionar" 
                                              rows="5" placeholder="Digite os números de patrimônio, um em cada linha" required></textarea>
                                </div>
                                <div class="col-md-4 d-flex align-items-end">
                                    <button class="btn btn-success w-100" @click="adicionarPatrimonios">
                                        <i class="fas fa-plus-circle"></i> Adicionar Patrimônios
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Lista de Equipamentos -->
                    <div v-for="tipo in tiposEquipamentos" :key="tipo">
                        <div class="estoque-toggle font-weight-bold mb-2" @click="toggleEstoque(tipo)">
                            <i :class="[iconeTipo(tipo),'mr-2']"></i> {{tipo}} – Disponíveis: {{contarDisponiveis(tipo)}} /
                            Total: {{equipamentos.filter(e=>e.tipo===tipo).length}} <i class="fas fa-chevron-down"></i>
                        </div>
                        <div v-if="estoqueVisivel[tipo]">
                            <div v-for="modelo in modelosPorTipo(tipo)" :key="modelo.modelo" class="card mb-3">
                                <div class="card-header py-2">
                                    <strong>{{ modelo.modelo }}</strong>
                                    <span class="badge badge-primary ml-2">
                                        {{ equipamentos.filter(e => e.tipo === tipo && e.modelo === modelo.modelo).length }} itens
                                    </span>
                                </div>
                                <div class="card-body p-0">
                                    <div class="patrimonio-list">
                                        <div v-for="equip in equipamentos.filter(e => e.tipo === tipo && e.modelo === modelo.modelo)" 
                                             :key="equip.patrimonio" class="patrimonio-item d-flex justify-content-between">
                                            <div>
                                                <i :class="[iconeTipo(equip.tipo), equip.situacao==='Disponível'?'icon-disponivel':'icon-indisponivel','mr-2']"></i>
                                                {{ equip.patrimonio }} – {{ equip.situacao }}
                                            </div>
                                            <button v-if="isAdmin" class="btn btn-sm btn-danger" @click="removerEquipamento(equip.patrimonio)">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Softwares -->
                <div v-if="abaAtiva==='softwares'">
                    <h4>Gerenciar Softwares</h4>
                    <div v-if="isAdmin" class="mb-3">
                        <h5>Adicionar Software</h5>
                        <form @submit.prevent="adicionarSoftware" class="form-inline">
                            <input class="form-control mr-2" type="text" v-model="novoSoftware.nome" placeholder="Nome do Software" required />
                            <input class="form-control mr-2" type="text" v-model="novoSoftware.chave" placeholder="Chave de Licença" required />
                            <select class="form-control mr-2" v-model="novoSoftware.situacao" required>
                                <option value="Disponível">Disponível</option>
                                <option value="Indisponível">Indisponível</option>
                            </select>
                            <button type="submit" class="btn btn-success">Adicionar</button>
                        </form>
                    </div>
                    
                    <h5>Softwares Cadastrados</h5>
                    <div v-if="softwares.length === 0" class="alert alert-info">Nenhum software cadastrado.</div>
                    <div v-else>
                        <div v-for="(sw, index) in softwares" :key="index" class="software-item">
                            <div class="software-info">
                                <strong>{{ sw.nome }}</strong> - {{ sw.chave }} 
                                <span :class="sw.situacao === 'Disponível' ? 'text-success' : 'text-danger'">
                                    ({{ sw.situacao }})
                                </span>
                            </div>
                            <div class="software-acoes">
                                <button v-if="isAdmin" class="btn btn-sm btn-primary mr-1" @click="editarSoftware(index)">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button v-if="isAdmin" class="btn btn-sm btn-danger" @click="removerSoftwareCadastrado(index)">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Usuários (SEM CPF) -->
                <div v-if="abaAtiva==='usuarios'">
                    <h4>Usuários</h4>
                    <div v-if="atribuicoes.length===0">Nenhuma atribuição feita.</div>
                    <div class="usuarios-scroll">
                        <div v-for="(a,i) in atribuicoes" :key="i" class="card-user">
                            <h5>{{a.usuario}}</h5>
                            <p><strong>Email:</strong> {{a.email}}</p>
                            <p><strong>Localização:</strong> {{a.localizacao}}</p>
                            <p><strong>Equipamentos:</strong></p>
                            <ul>
                                <li v-for="e in a.equipamentos" :key="e.patrimonio">{{e.tipo}} – {{e.modelo}} ({{e.patrimonio}})
                                </li>
                            </ul>
                            <p><strong>Softwares:</strong></p>
                            <ul>
                                <li v-for="s in a.softwares" :key="s.nome">{{s.nome}} – {{s.chave}}</li>
                            </ul>
                            <div class="mt-2">
                                <button class="btn btn-info btn-sm mr-2" @click="gerarTermoPDF(a)"><i
                                        class="fas fa-file-pdf"></i> Gerar Termo</button>
                                <button v-if="isAdmin" class="btn btn-warning btn-sm mr-2" @click="editarUsuario(i)"><i
                                        class="fas fa-edit"></i> Editar</button>
                                <button v-if="isAdmin" class="btn btn-danger btn-sm" @click="excluirUsuario(i)"><i class="fas fa-trash"></i>
                                    Excluir</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/vanilla-masker/1.2.0/vanilla-masker.min.js"></script>
    <script>
        new Vue({
            el: '#app',
            data: {
                usuarioLogado: false,
                isAdmin: false,
                login: {
                    usuario: '',
                    senha: ''
                },
                mensagemErro: '',
                abaAtiva: 'atribuicao',
                novoUsuario: '', novoEmail: '', novaLocalizacao: '', // Removido novoCpf
                equipamentosSelecionados: [], softwaresSelecionados: [{ nome: '', chave: '' }],
                estoqueVisivel: {}, 
                novoEquipamento: { 
                    tipo: '', 
                    modelo: '', 
                    patrimonio: '',
                    novoTipo: '' 
                },
                novoSoftware: { nome: '', chave: '', situacao: 'Disponível' },
                equipamentos: [], atribuicoes: [], softwares: [],
                mesRelatorio: new Date().getMonth() + 1, anoRelatorio: new Date().getFullYear(),
                adminCredentials: {
                    usuario: 'admin',
                    senha: 'admin123'
                },
                novoModelo: {
                    tipo: '',
                    modelo: '',
                    novoTipo: ''
                },
                modelosCadastrados: [],
                modeloSelecionado: null,
                patrimoniosParaAdicionar: ''
            },
            mounted() {
                const s = localStorage.getItem('sistema');
                if (s) { 
                    const st = JSON.parse(s); 
                    this.equipamentos = st.equipamentos || []; 
                    this.atribuicoes = st.atribuicoes || []; 
                    this.softwares = st.softwares || [];
                    this.modelosCadastrados = st.modelosCadastrados || this.extrairModelosUnicos(st.equipamentos || []);
                }
                else { 
                    this.equipamentos = [
                        { tipo: 'Monitor', modelo: 'Samsung 24"', patrimonio: 'M-S24-001', situacao: 'Disponível' },
                        { tipo: 'Monitor', modelo: 'Samsung 24"', patrimonio: 'M-S24-002', situacao: 'Disponível' },
                        { tipo: 'Notebook', modelo: 'Lenovo i5', patrimonio: 'N-L13-001', situacao: 'Disponível' },
                        { tipo: 'Notebook', modelo: 'Lenovo i5', patrimonio: 'N-L13-002', situacao: 'Disponível' }
                    ];
                    this.softwares = [
                        { nome: 'AutoCAD Collection', chave: 'AC-2023-XXXX', situacao: 'Disponível' },
                        { nome: 'GstarCAD', chave: 'GS-2023-YYYY', situacao: 'Disponível' },
                        { nome: 'CypeCAD', chave: 'CC-2023-ZZZZ', situacao: 'Disponível' }
                    ];
                    this.modelosCadastrados = this.extrairModelosUnicos(this.equipamentos);
                }
                
                const loggedIn = localStorage.getItem('loggedIn');
                if (loggedIn) {
                    this.usuarioLogado = true;
                    this.isAdmin = localStorage.getItem('isAdmin') === 'true';
                }
            },
            watch: {
                equipamentos: { 
                    handler: function(newVal) {
                        this.save();
                        this.modelosCadastrados = this.extrairModelosUnicos(newVal);
                    }, 
                    deep: true 
                }, 
                atribuicoes: { handler: 'save', deep: true },
                softwares: { handler: 'save', deep: true },
                modelosCadastrados: { handler: 'save', deep: true }
            },
            computed: {
                equipamentosDisponiveis() { return this.equipamentos.filter(e => e.situacao === 'Disponível') },
                softwaresDisponiveis() { return this.softwares },
                totalSoftwaresDisponiveis() { return this.softwares.filter(s => s.situacao === 'Disponível').length },
                totalSoftwaresIndisponiveis() { return this.softwares.filter(s => s.situacao === 'Indisponível').length },
                tiposEquipamentos() { return [...new Set(this.equipamentos.map(e => e.tipo))] },
                totaisDispositivos() { return this.tiposEquipamentos.map(tipo => { 
                    const total = this.equipamentos.filter(e => e.tipo === tipo).length; 
                    const dispon = this.contarDisponiveis(tipo); 
                    return { 
                        tipo, 
                        icone: this.iconeTipo(tipo), 
                        total, 
                        disponiveis: dispon, 
                        indisponiveis: total - dispon 
                    } 
                }) }
            },
            methods: {
                extrairModelosUnicos(equipamentos) {
                    const modelos = {};
                    equipamentos.forEach(e => {
                        const key = `${e.tipo}|${e.modelo}`;
                        if (!modelos[key]) {
                            modelos[key] = {
                                tipo: e.tipo,
                                modelo: e.modelo
                            };
                        }
                    });
                    return Object.values(modelos);
                },
                modelosPorTipo(tipo) {
                    return this.modelosCadastrados.filter(m => m.tipo === tipo);
                },
                adicionarModelo() {
                    const tipo = this.novoModelo.tipo === 'outro' 
                        ? this.novoModelo.novoTipo 
                        : this.novoModelo.tipo;
                    
                    const novoModelo = {
                        tipo: tipo,
                        modelo: this.novoModelo.modelo
                    };
                    
                    const modeloExistente = this.modelosCadastrados.find(m => 
                        m.tipo === novoModelo.tipo && m.modelo === novoModelo.modelo
                    );
                    
                    if (!modeloExistente) {
                        this.modelosCadastrados.push(novoModelo);
                        this.novoModelo = { tipo: '', modelo: '', novoTipo: '' };
                        alert('Modelo cadastrado com sucesso!');
                    } else {
                        alert('Este modelo já está cadastrado!');
                    }
                },
                adicionarPatrimonios() {
                    if (this.modeloSelecionado === null || this.modeloSelecionado === '') {
                        alert('Selecione um modelo primeiro!');
                        return;
                    }
                    
                    if (!this.patrimoniosParaAdicionar.trim()) {
                        alert('Digite pelo menos um número de patrimônio!');
                        return;
                    }
                    
                    const modelo = this.modelosCadastrados[this.modeloSelecionado];
                    const patrimonios = this.patrimoniosParaAdicionar.split('\n')
                        .map(p => p.trim())
                        .filter(p => p.length > 0);
                    
                    let adicionados = 0;
                    let duplicados = 0;
                    
                    patrimonios.forEach(patrimonio => {
                        const existe = this.equipamentos.some(e => e.patrimonio === patrimonio);
                        
                        if (!existe) {
                            this.equipamentos.push({
                                tipo: modelo.tipo,
                                modelo: modelo.modelo,
                                patrimonio: patrimonio,
                                situacao: 'Disponível'
                            });
                            adicionados++;
                        } else {
                            duplicados++;
                        }
                    });
                    
                    this.patrimoniosParaAdicionar = '';
                    
                    let mensagem = `${adicionados} patrimônios adicionados com sucesso para o modelo ${modelo.modelo}.`;
                    if (duplicados > 0) {
                        mensagem += ` ${duplicados} patrimônios não foram adicionados porque já existem.`;
                    }
                    
                    alert(mensagem);
                },
                fazerLogin() {
                    if (this.login.usuario === this.adminCredentials.usuario && 
                        this.login.senha === this.adminCredentials.senha) {
                        this.usuarioLogado = true;
                        this.isAdmin = true;
                        this.mensagemErro = '';
                        localStorage.setItem('loggedIn', 'true');
                        localStorage.setItem('isAdmin', 'true');
                    } else {
                        this.mensagemErro = 'Usuário ou senha incorretos';
                    }
                },
                entrarComoVisitante() {
                    this.usuarioLogado = true;
                    this.isAdmin = false;
                    localStorage.setItem('loggedIn', 'true');
                    localStorage.setItem('isAdmin', 'false');
                },
                sair() {
                    this.usuarioLogado = false;
                    this.isAdmin = false;
                    localStorage.removeItem('loggedIn');
                    localStorage.removeItem('isAdmin');
                    this.login.usuario = '';
                    this.login.senha = '';
                },
                save() { 
                    localStorage.setItem('sistema', JSON.stringify({ 
                        equipamentos: this.equipamentos, 
                        atribuicoes: this.atribuicoes,
                        softwares: this.softwares,
                        modelosCadastrados: this.modelosCadastrados
                    })); 
                },
                toggleEstoque(tipo) { this.$set(this.estoqueVisivel, tipo, !this.estoqueVisivel[tipo]) },
                iconeTipo(t) { 
                    if (t === 'Desktop') return 'fas fa-server'; 
                    if (t === 'Notebook') return 'fas fa-laptop'; 
                    if (t === 'Tablet') return 'fas fa-tablet-alt'; 
                    if (t === 'Monitor') return 'fas fa-tv'; 
                    return 'fas fa-box' 
                },
                contarDisponiveis(tipo) { return this.equipamentos.filter(e => e.tipo === tipo && e.situacao === 'Disponível').length },
                removerSoftware(i) { this.softwaresSelecionados.splice(i, 1) },
                selecionarSoftware(index) {
                    const nomeSoftware = this.softwaresSelecionados[index].nome;
                    const software = this.softwares.find(s => s.nome === nomeSoftware && s.situacao === 'Disponível');
                    if (software) {
                        this.softwaresSelecionados[index].chave = software.chave;
                        software.situacao = 'Indisponível';
                    }
                },
                atribuirEquipamentos() {
                    if (!this.novoUsuario || !this.equipamentosSelecionados.length) { 
                        alert('Informe nome e selecione pelo menos um equipamento.'); 
                        return 
                    }
                    
                    const atrib = {
                        usuario: this.novoUsuario,
                        email: this.novoEmail, 
                        localizacao: this.novaLocalizacao,
                        equipamentos: this.equipamentos.filter(e => this.equipamentosSelecionados.includes(e.patrimonio)),
                        softwares: [...this.softwaresSelecionados.filter(s => s.nome && s.chave)], 
                        data: new Date().toISOString()
                    };
                    
                    this.equipamentos = this.equipamentos.map(e => 
                        this.equipamentosSelecionados.includes(e.patrimonio) ? { ...e, situacao: 'Indisponível' } : e
                    );
                    
                    this.atribuicoes.push(atrib);
                    this.novoUsuario = this.novoEmail = this.novaLocalizacao = ''; 
                    this.equipamentosSelecionados = []; 
                    this.softwaresSelecionados = [{ nome: '', chave: '' }]; 
                    alert('Atribuição salva com sucesso.');
                },
                removerEquipamento(p) { 
                    if (confirm('Tem certeza que deseja remover este equipamento?')) {
                        const emUso = this.atribuicoes.some(a => 
                            a.equipamentos.some(e => e.patrimonio === p)
                        );
                        
                        if (emUso) {
                            alert('Este equipamento está atribuído a um usuário e não pode ser removido!');
                            return;
                        }
                        
                        const i = this.equipamentos.findIndex(e => e.patrimonio === p); 
                        if (i >= 0) this.equipamentos.splice(i, 1);
                    }
                },
                adicionarSoftware() {
                    this.softwares.push({ ...this.novoSoftware });
                    this.novoSoftware = { nome: '', chave: '', situacao: 'Disponível' };
                },
                removerSoftwareCadastrado(index) {
                    if (confirm('Tem certeza que deseja remover este software?')) {
                        const sw = this.softwares[index];
                        const emUso = this.atribuicoes.some(a => 
                            a.softwares.some(s => s.nome === sw.nome && s.chave === sw.chave)
                        );
                        
                        if (emUso) {
                            alert('Este software está atribuído a um usuário e não pode ser removido!');
                            return;
                        }
                        
                        this.softwares.splice(index, 1);
                    }
                },
                editarSoftware(index) {
                    const sw = this.softwares[index];
                    this.novoSoftware = { ...sw };
                    this.softwares.splice(index, 1);
                },
                excluirUsuario(i) { 
                    if (confirm("Excluir essa atribuição?")) { 
                        const a = this.atribuicoes[i]; 
                        a.equipamentos.forEach(eq => { 
                            const e = this.equipamentos.find(x => x.patrimonio === eq.patrimonio); 
                            if (e) e.situacao = 'Disponível' 
                        }); 
                        a.softwares.forEach(sw => {
                            const s = this.softwares.find(x => x.nome === sw.nome && x.chave === sw.chave);
                            if (s) s.situacao = 'Disponível';
                        });
                        this.atribuicoes.splice(i, 1); 
                    } 
                },
                editarUsuario(i) { 
                    const a = this.atribuicoes[i]; 
                    this.novoUsuario = a.usuario; 
                    this.novoEmail = a.email; 
                    this.novaLocalizacao = a.localizacao; 
                    this.equipamentosSelecionados = a.equipamentos.map(e => e.patrimonio); 
                    this.softwaresSelecionados = JSON.parse(JSON.stringify(a.softwares)); 
                    a.equipamentos.forEach(eq => { 
                        const e = this.equipamentos.find(x => x.patrimonio === eq.patrimonio); 
                        if (e) e.situacao = 'Disponível' 
                    });
                    a.softwares.forEach(sw => {
                        const s = this.softwares.find(x => x.nome === sw.nome && x.chave === sw.chave);
                        if (s) s.situacao = 'Disponível';
                    });
                    this.atribuicoes.splice(i, 1); 
                    this.abaAtiva = 'atribuicao' 
                },
                gerarRelatorio() {
                    const rows = this.atribuicoes.filter(a => { 
                        const d = new Date(a.data); 
                        return d.getMonth() + 1 === this.mesRelatorio && d.getFullYear() === this.anoRelatorio 
                    }).map(a => [
                        a.data, 
                        a.usuario, 
                        a.email, 
                        a.localizacao, 
                        a.equipamentos.length, 
                        a.softwares.length
                    ]);
                    
                    const header = ['Data', 'Usuário', 'Email', 'Localização', '# Equip', 'Softwares'];
                    const csv = [header, ...rows].map(r => r.map(c => `"${c}"`).join(',')).join('\r\n');
                    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' }); 
                    const fname = `relatorio-${this.anoRelatorio}-${String(this.mesRelatorio).padStart(2, '0')}.csv`;
                    if (navigator.msSaveBlob) navigator.msSaveBlob(blob, fname); 
                    else { 
                        const link = document.createElement('a'); 
                        link.href = URL.createObjectURL(blob); 
                        link.download = fname; 
                        link.click(); 
                        URL.revokeObjectURL(link.href); 
                    }
                },
                gerarTermoPDF(a) {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    
                    const margin = 15;
                    const lineHeight = 7;
                    let y = margin;
                    
                    doc.setFontSize(16);
                    doc.setFont('helvetica', 'bold');
                    doc.text('STCP ENGENHARIA', 105, y, { align: 'center' });
                    y += lineHeight;
                    
                    doc.setFontSize(14);
                    doc.text('TERMO DE RESPONSABILIDADE', 105, y, { align: 'center' });
                    y += lineHeight * 2;
                    
                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'normal');
                    
                    const dataFormatada = new Date(a.data).toLocaleDateString('pt-BR');
                    
                    doc.text(`Eu, ${a.usuario}, lotado(a) em ${a.localizacao},`, margin, y);
                    y += lineHeight;
                    doc.text(`declaro ter recebido da STCP ENGENHARIA os equipamentos e softwares abaixo`, margin, y);
                    y += lineHeight;
                    doc.text(`relacionados em ${dataFormatada}:`, margin, y);
                    y += lineHeight * 1.5;
                    
                    doc.setFont('helvetica', 'bold');
                    doc.text('Equipamentos:', margin, y);
                    y += lineHeight;
                    
                    doc.setFont('helvetica', 'normal');
                    a.equipamentos.forEach(eq => {
                        doc.text(`- ${eq.tipo} “${eq.modelo}” — Patrimônio ${eq.patrimonio}`, margin + 5, y);
                        y += lineHeight;
                    });
                    
                    y += lineHeight * 0.5;
                    
                    doc.setFont('helvetica', 'bold');
                    doc.text('Softwares:', margin, y);
                    y += lineHeight;
                    
                    doc.setFont('helvetica', 'normal');
                    a.softwares.forEach(sw => {
                        doc.text(`- ${sw.nome} — Licença ${sw.chave}`, margin + 5, y);
                        y += lineHeight;
                    });
                    
                    y += lineHeight * 1.5;
                    
                    doc.text('Comprometo-me a:', margin, y);
                    y += lineHeight;
                    doc.text('• Zelar pela integridade física e conservação dos equipamentos;', margin + 5, y);
                    y += lineHeight;
                    doc.text('• Não os emprestar ou transferi-los;', margin + 5, y);
                    y += lineHeight;
                    doc.text('• Comunicar imediatamente qualquer dano, extravio ou furto;', margin + 5, y);
                    y += lineHeight;
                    doc.text('• Devolvê-los nas mesmas condições ao término do uso ou solicitação.', margin + 5, y);
                    y += lineHeight * 2;
                    
                    doc.text(`Goiânia, ${dataFormatada}.`, margin, y);
                    y += lineHeight * 3;
                    
                    doc.text('___________________________________', 105, y, { align: 'center' });
                    y += lineHeight;
                    doc.text('(Assinatura do responsável)', 105, y, { align: 'center' });
                    
                    doc.save(`termo_responsabilidade_${a.usuario}_${dataFormatada.replace(/\//g, '-')}.pdf`);
                }
            }
        });
    </script>
</body>
</html>
